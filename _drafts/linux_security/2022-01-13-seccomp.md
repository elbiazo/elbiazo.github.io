---
title: SECCOMP
date: 2022-01-13
categories: [linux security]
tags: [linux, seccomp]
---

# SECCOMP

## STRICT_MODE

This mode allows system to only call `read`, `write`, `exit`, `sigreturn`. If any other system is called, `SIGKILL` signal will be generated and then program is terminated.

To use seccomp you can use `prctl` function.

### Example 1

In this code, it will be Killed when `open`.

```c
// Example from dreamhack.io
// Name: strict_mode.c
// Compile: gcc -o strict_mode strict_mode.c
#include <fcntl.h>
#include <linux/seccomp.h>
#include <sys/prctl.h>
#include <unistd.h>
void init_filter() { prctl(PR_SET_SECCOMP, SECCOMP_MODE_STRICT); }
int main() {
  char buf[256];
  int fd = 0;
  init_filter();
  write(1, "OPEN!\n", 6);
  fd = open("/bin/sh", O_RDONLY);
  write(1, "READ!\n", 6);
  read(fd, buf, sizeof(buf) - 1);
  write(1, buf, sizeof(buf));
  return 0;
}
```

![](/assets/img/2022-02-13-15-28-25.png)

When we look at how compsec actuallys works, it will have array of syscall number `mode1_syscalls` and it will be used in function __secure_computing which checks if passed system call number matches any value in `model_syscalls`. If it does not match, it will `SIGKILL` and return `SECCOMP_RET_KILL`.

```c
// Example from dreamhack.io
static const int mode1_syscalls[] = {
    __NR_seccomp_read,
    __NR_seccomp_write,
    __NR_seccomp_exit,
    __NR_seccomp_sigreturn,
    -1, /* negative terminated */
};
#ifdef CONFIG_COMPAT
static int mode1_syscalls_32[] = {
    __NR_seccomp_read_32,
    __NR_seccomp_write_32,
    __NR_seccomp_exit_32,
    __NR_seccomp_sigreturn_32,
    0, /* null terminated */
};
#endif
static void __secure_computing_strict(int this_syscall) {
  const int *allowed_syscalls = mode1_syscalls;
#ifdef CONFIG_COMPAT
  if (in_compat_syscall()) allowed_syscalls = get_compat_mode1_syscalls();
#endif
  do {
    if (*allowed_syscalls == this_syscall) return;
  } while (*++allowed_syscalls != -1);
#ifdef SECCOMP_DEBUG
  dump_stack();
#endif
  seccomp_log(this_syscall, SIGKILL, SECCOMP_RET_KILL_THREAD, true);
  do_exit(SIGKILL);
}
```

## FILTER_MODE

This mode can allow or deny the invocation of the desired system call.

| function | Explnation |
| --- | --- |
| seccomp_init | This function sets the default value of SECCOMP mode |
| seccomp_rule_add | Add rules for allow or deny |
| seccomp_load | Rules applied earlier are reflected in the application |




## Resources

[dreamhack.io](https://dreamhack.io/)
[seccomp-tools](https://github.com/david942j/seccomp-tools)